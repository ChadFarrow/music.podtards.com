import e from"crypto-js";import t from"events";import{generatePrivateKey as n,relayInit as s,nip19 as o,getPublicKey as r,finishEvent as i,getEventHash as a,nip04 as c}from"nostr-tools";function u(){return u=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},u.apply(this,arguments)}function h(e,t){if(null==e)return{};var n,s,o={},r=Object.keys(e);for(s=0;s<r.length;s++)t.indexOf(n=r[s])>=0||(o[n]=e[n]);return o}function l(e){return Object.entries(e).map(([e,t])=>e&&t?`${e}=${t}`:"").filter(e=>e).join("&")}function d(e,t){return`Basic ${btoa(`${e}:${t}`)}`}class p extends Error{constructor(e,t,n,s){let o=e.toString();t&&(o+=` ${t}`),o+=": ",o+=s.message?s.message:JSON.stringify(s),super(o),this.status=void 0,this.statusText=void 0,this.headers=void 0,this.error=void 0,this.status=e,this.statusText=t,this.headers=n,this.error=s}}var m={__proto__:null,OAuthClient:class{},AuthClient:class{},AlbyResponseError:p};const y=["auth","endpoint","params","request_body","method","max_retries","base_url","user_agent","headers"],w="https://api.getalby.com";async function g(e,t,n=0){const s=await fetch(e,t);if(429===s.status&&n>0){const o=Number(s.headers.get("x-rate-limit-reset")),r=Number(s.headers.get("x-rate-limit-remaining")),i=1e3*o-Date.now();let a=1e3;return 0===r&&(a=i),await new Promise(e=>setTimeout(e,a)),g(e,t,n-1)}return s}async function f(e){let{auth:t,endpoint:n,params:s={},request_body:o,method:r,max_retries:i,base_url:a=w,user_agent:c,headers:d}=e,m=h(e,y);const f=new URL(a+n);f.search=l(s);const v="POST"===r&&!!o,b=t?await t.getAuthHeader(f.href,r):void 0,_=await g(f.toString(),u({headers:u({},v?{"Content-Type":"application/json; charset=utf-8"}:void 0,b,d,{"User-Agent":null!=c?c:"@getalby/sdk","X-User-Agent":null!=c?c:"@getalby/sdk"}),method:r,body:v?JSON.stringify(o):void 0},m),i);if(!_.ok){const e=await _.json();throw new p(_.status,_.statusText,_.headers,e)}return _}async function v(e){return(await f(e)).json()}const b=["expires_in"],_=["token"];function k(e){const{expires_in:t}=e;return u({},h(e,b),!!t&&{expires_at:Date.now()+1e3*t})}class E{constructor(e){this.bearer_token=void 0,this.bearer_token=e}getAuthHeader(){return{Authorization:`Bearer ${this.bearer_token}`}}}var P={__proto__:null,OAuth2User:class{constructor(e){this.token=void 0,this.options=void 0,this.code_verifier=void 0,this.code_challenge=void 0,this._refreshAccessTokenPromise=void 0,this._tokenEvents=void 0,this._tokenEvents=new t;const{token:n}=e,s=h(e,_);this.options=u({client_secret:""},s),this.token=n,this._refreshAccessTokenPromise=null}on(e,t){this._tokenEvents.on(e,t)}async refreshAccessToken(){var e=this;return this._refreshAccessTokenPromise||(this._refreshAccessTokenPromise=new Promise(async function(t,n){try{var s;const n=null==(s=e.token)?void 0:s.refresh_token,{client_id:o,client_secret:r,request_options:i,user_agent:a}=e.options;if(!o)throw new Error("client_id is required");if(!n)throw new Error("refresh_token is required");const c=k(await v(u({},i,{endpoint:"/oauth/token",params:{client_id:o,grant_type:"refresh_token",refresh_token:n},user_agent:a,method:"POST",headers:u({},null==i?void 0:i.headers,{"Content-type":"application/x-www-form-urlencoded"},{Authorization:d(o,r)})})));e.token=c,t({token:c}),e._tokenEvents.emit("tokenRefreshed",e.token)}catch(t){console.log(t),n(t),e._tokenEvents.emit("tokenRefreshFailed",t)}finally{e._refreshAccessTokenPromise=null}})),this._refreshAccessTokenPromise}isAccessTokenExpired(){var e,t;const n=null==(e=this.token)?void 0:e.refresh_token,s=null==(t=this.token)?void 0:t.expires_at;return!s||!!n&&s<=Date.now()+1e3}async requestAccessToken(e){const{client_id:t,client_secret:n,callback:s,request_options:o,user_agent:r}=this.options,i=this.code_verifier;if(!t)throw new Error("client_id is required");if(!n&&!i)throw new Error("either client_secret is required, or code should be generated using a challenge");if(!s)throw new Error("callback is required");const a={code:e,grant_type:"authorization_code",code_verifier:i,client_id:t,redirect_uri:s},c=k(await v(u({},o,{endpoint:"/oauth/token",params:a,user_agent:r,method:"POST",headers:u({},null==o?void 0:o.headers,{"Content-Type":"application/x-www-form-urlencoded"},{Authorization:d(t,n)})})));return this.token=c,{token:c}}generateAuthURL(t){t||(t={}),console.log(t);const{client_id:n,callback:s,scopes:o}=this.options;if(!s)throw new Error("callback required");if(!o)throw new Error("scopes required");let r;if("S256"===t.code_challenge_method){const t=e.lib.WordArray.random(64);this.code_verifier=t.toString(),this.code_challenge=e.SHA256(this.code_verifier).toString(e.enc.Base64).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=+$/,""),r="S256"}else"plain"===t.code_challenge_method&&t.code_challenge&&(this.code_challenge=t.code_challenge,this.code_verifier=t.code_challenge,r="plain");const i=this.code_challenge,a=new URL(t.authorizeUrl||"https://getalby.com/oauth");return a.search=l(u({},t,{client_id:n,scope:o.join(" "),response_type:"code",redirect_uri:s,code_challenge_method:r,code_challenge:i})),a.toString()}async getAuthHeader(){var e;if(null==(e=this.token)||!e.access_token)throw new Error("access_token is required");return this.isAccessTokenExpired()&&await this.refreshAccessToken(),{Authorization:`Bearer ${this.token.access_token}`}}},OAuth2Bearer:E};const A={alby:{authorizationUrl:"https://nwc.getalby.com/apps/new",relayUrl:"wss://relay.getalby.com/v1",walletPubkey:"69effe7b49a6dd5cf525bd0905917a5005ffe480b58eeb8e861418cf3ae760d9"}},T={get_balance:"getBalance",make_invoice:"makeInvoice",pay_invoice:"sendPayment",lookup_invoice:"lookupInvoice"};class q{static parseWalletConnectUrl(e){e=e.replace("nostrwalletconnect://","http://").replace("nostr+walletconnect://","http://");const t=new URL(e),n={};n.walletPubkey=t.host;const s=t.searchParams.get("secret"),o=t.searchParams.get("relay");return s&&(n.secret=s),o&&(n.relayUrl=o),n}static withNewSecret(e){return(e=e||{}).secret=n(),new q(e)}constructor(e){var t;this.relay=void 0,this.relayUrl=void 0,this.secret=void 0,this.walletPubkey=void 0,this.options=void 0,this.subscribers=void 0,e&&e.nostrWalletConnectUrl&&(e=u({},q.parseWalletConnectUrl(e.nostrWalletConnectUrl),e));const n=A[(null==(t=e)?void 0:t.providerName)||"alby"];this.options=u({},n,e||{}),this.relayUrl=this.options.relayUrl,this.relay=s(this.relayUrl),this.options.secret&&(this.secret=this.options.secret.toLowerCase().startsWith("nsec")?o.decode(this.options.secret).data:this.options.secret),this.walletPubkey=this.options.walletPubkey.toLowerCase().startsWith("npub")?o.decode(this.options.walletPubkey).data:this.options.walletPubkey,this.subscribers={},void 0===globalThis.WebSocket&&console.error("WebSocket is undefined. Make sure to `import websocket-polyfill` for nodejs environments")}on(e,t){this.subscribers[e]=t}notify(e,t){const n=this.subscribers[e];n&&n(t)}getNostrWalletConnectUrl(e=!0){let t=`nostr+walletconnect://${this.walletPubkey}?relay=${this.relayUrl}&pubkey=${this.publicKey}`;return e&&(t=`${t}&secret=${this.secret}`),t}get nostrWalletConnectUrl(){return this.getNostrWalletConnectUrl()}get connected(){return 1===this.relay.status}get publicKey(){if(!this.secret)throw new Error("Missing secret key");return r(this.secret)}getPublicKey(){return Promise.resolve(this.publicKey)}signEvent(e){if(!this.secret)throw new Error("Missing secret key");return Promise.resolve(i(e,this.secret))}getEventHash(e){return a(e)}async enable(){if(this.connected)return Promise.resolve();await this.relay.connect()}close(){return this.relay.close()}async encrypt(e,t){if(!this.secret)throw new Error("Missing secret");return await c.encrypt(this.secret,e,t)}async decrypt(e,t){if(!this.secret)throw new Error("Missing secret");return await c.decrypt(this.secret,e,t)}async getInfo(){return{methods:["getInfo","sendPayment","makeInvoice","getBalance","lookupInvoice"],node:{},supports:["lightning"],version:"NWC"}}getBalance(){return this.checkConnected(),this.executeNip47Request("get_balance",void 0,e=>void 0!==e.balance,e=>({balance:Math.floor(e.balance/1e3),currency:"sats"}))}sendPayment(e){return this.checkConnected(),this.executeNip47Request("pay_invoice",{invoice:e},e=>!!e.preimage,e=>({preimage:e.preimage}))}keysend(e){throw new Error("Method not implemented.")}lnurl(e){throw new Error("Method not implemented.")}makeInvoice(e){var t;this.checkConnected();const n="object"==typeof e?e:void 0,s=+(null!=(t=null==n?void 0:n.amount)?t:e);if(!s)throw new Error("No amount specified");return this.executeNip47Request("make_invoice",{amount:1e3*s,description:null==n?void 0:n.defaultMemo},e=>!!e.invoice,e=>({paymentRequest:e.invoice}))}lookupInvoice(e){return this.checkConnected(),this.executeNip47Request("lookup_invoice",e,e=>void 0!==e.invoice&&void 0!==e.paid,e=>({paymentRequest:e.invoice,paid:e.paid}))}request(e,t){throw new Error("Method not implemented.")}signMessage(e){throw new Error("Method not implemented.")}verifyMessage(e,t){throw new Error("Method not implemented.")}getAuthorizationUrl(e){if(!this.options.authorizationUrl)throw new Error("Missing authorizationUrl option");const t=new URL(this.options.authorizationUrl);return null!=e&&e.name&&t.searchParams.set("c",null==e?void 0:e.name),t.searchParams.set("pubkey",this.publicKey),null!=e&&e.returnTo&&t.searchParams.set("return_to",e.returnTo),null!=e&&e.budgetRenewal&&t.searchParams.set("budget_renewal",e.budgetRenewal),null!=e&&e.expiresAt&&t.searchParams.set("expires_at",Math.floor(e.expiresAt.getTime()/1e3).toString()),null!=e&&e.maxAmount&&t.searchParams.set("max_amount",e.maxAmount.toString()),void 0!==(null==e?void 0:e.editable)&&t.searchParams.set("editable",e.editable.toString()),t}initNWC(e={}){e.name||(e.name=document.location.host);const t=this.getAuthorizationUrl(e),n=window.outerHeight/2+window.screenY-300,s=window.outerWidth/2+window.screenX-200;return new Promise((e,o)=>{const r=window.open(t.toString(),`${document.title} - Wallet Connect`,`height=600,width=400,top=${n},left=${s}`);if(!r)return void o();const i=n=>{const s=n.data;s&&"nwc:success"===s.type&&n.origin===`${t.protocol}//${t.host}`&&(e(s),clearInterval(a),window.removeEventListener("message",i),r&&r.close())},a=setInterval(()=>{r&&r.closed&&(o(),clearInterval(a),window.removeEventListener("message",i))},500);window.addEventListener("message",i)})}checkConnected(){if(!this.connected)throw new Error("please call enable() and await the promise before calling this function")}executeNip47Request(e,t,n,s){var o=this;const r=T[e];return new Promise((i,a)=>{!async function(){const c={method:e,params:t},u=await o.encrypt(o.walletPubkey,JSON.stringify(c)),h={kind:23194,created_at:Math.floor(Date.now()/1e3),tags:[["p",o.walletPubkey]],content:u,pubkey:o.publicKey},l=await o.signEvent(h),d=o.relay.sub([{kinds:[23195],authors:[o.walletPubkey],"#e":[l.id]}]),p=setTimeout(function(){d.unsub(),a({error:`reply timeout: event ${l.id}`,code:"INTERNAL"})},6e4);d.on("event",async function(e){clearTimeout(p),d.unsub();const t=await o.decrypt(o.walletPubkey,e.content);let c;try{c=JSON.parse(t)}catch(e){return void a({error:"invalid response",code:"INTERNAL"})}var u,h;23195==e.kind&&c.result?n(c.result)?(i(s(c.result)),o.notify(r,c.result)):a({error:"Response from NWC failed validation: "+JSON.stringify(c.result),code:"INTERNAL"}):a({error:null==(u=c.error)?void 0:u.message,code:null==(h=c.error)?void 0:h.code})});const m=setTimeout(function(){a({error:`Publish timeout: event ${l.id}`})},5e3);try{await o.relay.publish(l),clearTimeout(m)}catch(e){clearTimeout(m),a({error:`Failed to publish request: ${e}`})}}()})}}const O=q;function R(e){const t={};return e.recipient.customKey&&e.recipient.customValue&&(t[e.recipient.customKey]=e.recipient.customValue),t[7629169]=JSON.stringify(e.boostagram),{destination:e.recipient.address,amount:e.amount,customRecords:t}}class x{constructor(e,t){this.auth=void 0,this.defaultRequestOptions=void 0,this.auth="string"==typeof e?new E(e):e,this.defaultRequestOptions=u({},t,{user_agent:null==t?void 0:t.user_agent})}accountBalance(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/balance",params:e,method:"GET"}))}accountSummary(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/user/summary",params:e,method:"GET"}))}accountInformation(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/user/me",params:e,method:"GET"}))}accountValue4Value(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/user/value4value",params:e,method:"GET"}))}incomingInvoices(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices/incoming",params:e,method:"GET"}))}outgoingInvoices(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices/outgoing",params:e,method:"GET"}))}invoices(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices",params:e,method:"GET"}))}getInvoice(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:`/invoices/${e}`,method:"GET"}))}decodeInvoice(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:`/decode/bolt11/${e}`,method:"GET"}))}createInvoice(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices",request_body:e,method:"POST"}))}keysend(e,t){let n,s;return Array.isArray(e)?(n="/payments/keysend/multi",s={keysends:e}):(n="/payments/keysend",s=e),v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:n,request_body:s,method:"POST"}))}sendPayment(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/payments/bolt11",request_body:e,method:"POST"}))}sendBoostagram(e,t){let n,s;return Array.isArray(e)?(n="/payments/keysend/multi",s={keysends:e.map(e=>R(e))}):(n="/payments/keysend",s=R(e)),v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:n,request_body:s,method:"POST"}))}sendToAlbyAccount(e,t){return console.warn("sendToAlbyAccount is deprecated. Please use sendBoostagramToAlbyAccount instead."),this.sendBoostagramToAlbyAccount(e,t)}sendBoostagramToAlbyAccount(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/payments/keysend",request_body:{destination:"030a58b8653d32b99200a2334cfe913e51dc7d155aa0116c176657a4f1722677a3",customRecords:{696969:e.account},amount:e.amount,memo:e.memo},method:"POST"}))}createWebhookEndpoint(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/webhook_endpoints",request_body:e,method:"POST"}))}deleteWebhookEndpoint(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:`/webhook_endpoints/${e}`,method:"DELETE"}))}getSwapInfo(e){return v(u({auth:this.auth},this.defaultRequestOptions,e,{endpoint:"/swaps/info",method:"GET"}))}createSwap(e,t){return v(u({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/swaps",method:"POST",request_body:e}))}}var S={__proto__:null,NostrWebLNProvider:q,NWC:O,OauthWeblnProvider:class{constructor(e){this.client=void 0,this.auth=void 0,this.oauth=void 0,this.subscribers=void 0,this.isExecuting=void 0,this.auth=e.auth,this.client=new x(e.auth),this.oauth=!0,this.subscribers={},this.isExecuting=!1}on(e,t){this.subscribers[e]=t}notify(e,t){const n=this.subscribers[e];n&&n(t)}async enable(){var e;if(!this.isExecuting){if(null!=(e=this.auth.token)&&e.access_token)return{enabled:!0};if("undefined"==typeof window||void 0===window.document)throw new Error("Missing access token");try{this.isExecuting=!0,await this.openAuthorization()}finally{this.isExecuting=!1}}}async sendPayment(e){if(!this.isExecuting)try{this.isExecuting=!0;const t=await this.client.sendPayment({invoice:e});return this.notify("sendPayment",t),{preimage:t.payment_preimage}}catch(e){let t="Unknown Error";throw e instanceof Error&&(t=e.message),new Error(t)}finally{this.isExecuting=!1}}async keysend(e){if(!this.isExecuting)try{this.isExecuting=!0;const t=await this.client.keysend(e);return this.notify("keysend",t),{preimage:t.payment_preimage}}catch(e){let t="Unknown Error";throw e instanceof Error&&(t=e.message),new Error(t)}finally{this.isExecuting=!1}}async getInfo(){return{alias:"Alby"}}async makeInvoice(e){if(!this.isExecuting)try{this.isExecuting=!0;const t=await this.client.createInvoice({amount:parseInt(e.amount.toString()),description:e.defaultMemo});return this.notify("makeInvoice",t),{paymentRequest:t.payment_request}}catch(e){let t="Unknown Error";throw e instanceof Error&&(t=e.message),new Error(t)}finally{this.isExecuting=!1}}openAuthorization(){var e=this;const t=window.outerHeight/2+window.screenY-350,n=window.outerWidth/2+window.screenX-300,s=this.auth.generateAuthURL({code_challenge_method:"S256"});return new Promise((o,r)=>{const i=window.open(s,`${document.title} - WebLN enable`,`height=700,width=600,top=${t},left=${n}`);let a=!1;window.addEventListener("message",async function(t){const n=t.data;if(n&&"alby:oauth:success"===n.type&&t.origin===`${document.location.protocol}//${document.location.host}`&&!a){a=!0,console.info("Processing OAuth code response");const t=n.payload.code;try{await e.auth.requestAccessToken(t),e.client=new x(e.auth),i&&i.close(),e.notify("enable"),o({enabled:!0})}catch(e){console.error(e),r({enabled:!1})}}})})}}};export{x as Client,P as auth,m as types,S as webln};
//# sourceMappingURL=index.modern.js.map
